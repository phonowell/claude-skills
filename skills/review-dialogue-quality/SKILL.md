---
name: review-dialogue-quality
description: 监控对话质量与成本并输出可执行改进，use when checking conversation quality or reviewing work progress
allowed-tools: Read, Grep, Glob, Bash, Edit
---

# 对话质量复盘

## 何时使用

- 用户请求质量检查（如“总结对话质量”“检查 token 效率”）
- 任务阶段结束后主动复盘执行质量

## 核心意图

用量化证据定位低效模式，降低 token 成本与执行时间，并给出可执行补丁建议。

## 效率优先

默认仅依赖会话上下文；缺关键数据时最小化读取日志/计划文件。

## 核心约束

1. 证据驱动：每条结论必须有数据依据（实际或估算）
2. 非侵入式：默认只输出建议，不直接修改文件
3. Token 敏感：优先定位高成本动作（重复读取/误用工具/低并行）
4. 可执行补丁：建议必须含 `文件/位置/动作`
5. 任务对齐：核对任务完成度与计划文件更新状态
6. 附件一致性：若存在 `example.md`/`reference.md`，需与本评分维度和输出格式一致

## 输入/输出契约

- 输入：成本统计或执行日志、工具调用信息、任务计划记录（如 `/plans/task_plan_{suffix}.md`）
- 缺失处理：可估算，需明确标注“估算”
- 输出：固定四行，均含数据依据
  `Token: ...`
  `工具: ...`
  `任务: ...`
  `补丁: 文件:{path} · 位置:[章节] · 建议:{action} · 状态:✓ 检查完成/✗ 中断:{原因}`

## 评分维度

1. Token 效率（最高优先级）
- 指标：总消耗、重复读取（≥2次）、Task 误用、并行度
- 阈值：✅ <1500 · ⚠️ 1500-2000 · ❌ >2000
2. 工具规范
- 指标：Grep/Glob 使用、Write/Edit 选择、并行执行、先读后改
- 评分：✅ 严格遵循 · ⚠️ 1-2 处偏差 · ❌ 频繁违反
3. 任务完成
- 指标：计划更新、功能完整性、必要检查执行（lint/type-check/test）
- 评分：✅ 完整 · ⚠️ 主要完成或记录缺失 · ❌ 明显遗漏
4. Skill 使用（如有）
- 指标：触发时机、目标达成、token 效率、替代方案

## 工作流程

1. 前置检查：确认是否有成本统计/日志；缺失则启用估算
2. 收集分析：统计 token、工具模式、计划更新、检查执行情况
3. 维度评分：按四维度输出 ✅/⚠️/❌ 与量化理由
4. 补丁生成：给出最小改动建议，默认不执行 Edit
5. 固定返回：按四行模板输出；阻塞时在补丁行给出 `✗ 中断:{原因}`

## 验证清单

- [ ] 费用来源明确（实际或估算已标注）
- [ ] 工具规范问题已列出（重复读/错误工具/未并行）
- [ ] 任务完成度核对（`/plans/task_plan_{suffix}.md` 更新，检查/验证情况）
- [ ] 补丁建议含文件/位置/建议，未执行 Edit
- [ ] 输出格式正确（固定四行 + 数据依据）

## 证据模板

```text
Token: ❌ ~270K ($6.07) | input 230K + output 40.6K | 估算: 否
工具: ✅ 25 轮 3 处并行 | 主要偏差: 无
任务: ✅ 完整 lint/type-check/test 通过 | 记录: /plans/task_plan_xxx 已更新
补丁: 文件: .claude/skills/foo/SKILL.md · 位置: [核心约束] · 建议: 强制并行读取 · 状态: ✓ 检查完成
```
