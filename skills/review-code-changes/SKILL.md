---
name: review-code-changes
description: 反复复盘代码修改验证真实性/正确性/优雅性/最小化原则，use when code modifications need quality review
allowed-tools: Read, Grep, Glob, Bash, Edit
---

# 代码修改复盘验证

## 何时使用

agent 修改代码后需要质量验证 · 确保满足真实/正确/优雅/最小化原则

**核心意图**：通过多轮复盘发现并修复代码问题，避免低质量代码进入代码库

**效率优先**

Read/Grep/Bash > Task · 并行≤3 · 只审查最近变更的代码，避免审查范围过广

## 验证维度

**真实性**：解决实际问题，避免过度抽象 · **正确性**：逻辑无误，类型安全 · **优雅性**：符合项目规范，代码清晰 · **最小化**：只改必要部分，无冗余

## 工作流程

**跳过确认需求**：触发时机明确（代码修改后），直接执行

### 1. 识别修改范围

使用 `git diff` 或用户指定范围确定**最近变更的**文件和代码块（仅审最近变更）

### 2. 真实性审查

解决实际问题（非假想需求）· 避免过度抽象（<3次重复不提取）· 避免不必要配置化

**✗** 指出问题 · 建议简化 · 重新修改

### 3. 正确性审查

`type-check` 检查类型 · 逻辑完整性（边界/空值）· 依赖正确性（导入路径/扩展名）；必要时用针对性测试替代全量（但至少跑相关测试）

**少用断言，类型自然流动**：应该通过类型设计让数据自然流动，断言是代码异味

**✗** 执行修复 · 重新验证

### 4. 优雅性审查

遵循项目规范（CLAUDE.md/ESLint）· 命名清晰（避免缩写/单字母）· 结构合理（组件拆分/函数职责单一）

**声明和消费要靠近**：变量/函数定义后立即使用，避免跨文件/跨函数跳跃，减少认知负担

**✗** 重构代码 · 重新验证

### 5. 最小化审查

**简化 = 删除 + 合并 + 内联**

- 删除：未使用的代码是债务
- 合并：重复的抽象是噪音
- 内联：不必要的包装是间接

最终目标：让代码的结构直接反映其功能，而不是反映历史决策的累积。

检查未使用代码（变量/导入/函数）· 不必要依赖 · 重复逻辑可合并 · 提取公共函数 · 消除不必要的配置化 · 寻找项目结构优化机会（拆分过大的函数/组件）· 使用 if-return 扁平化嵌套，以清晰为第一目标

**✗** 清理冗余 · 重新验证

### 6. 循环验证

**多轮复盘**：重复步骤 2-5 直到所有维度通过  
验证策略：优先跑相关测试/目标子集，最终一轮至少执行 `lint & type-check & test`（再视情况跑关键测试）

每轮输出：`→ 第{N}轮 ✓真实性 ✓正确性 ✗优雅性:{问题} ✗最小化:{问题}`

### 7. 返回结果

通过：`✓ 代码复盘完成，满足所有质量要求` · 中断：`✗ 复盘中断：{原因}`

## 验证清单

- [ ] 仅审最近变更，范围准确认定
- [ ] 真实性：解决实际问题，无过度抽象/配置化
- [ ] 正确性：类型/边界/依赖检查，相关测试或全量验证已跑
- [ ] 优雅性：命名/结构符合规范，声明与消费相邻
- [ ] 最小化：无未用/重复/不必要包装，必要提取/合并已做
- [ ] 最终一轮执行 `lint & type-check & test`，必要测试通过
- [ ] 返回信息按格式输出，列出未解决问题（如有）

## 示例

为 Button 添加 loading 状态

- 第1轮：✓真实性 ✗正确性:缺 `loading?: boolean` → 修复类型 → `lint & type-check & test` ✓
- 第2轮：✓真实性 ✓正确性 ✗优雅性:未用 `clsx` → 重构 className → `lint & type-check & test` ✓
- 第3轮：✓真实性 ✓正确性 ✓优雅性 ✗最小化:未使用 `useState` + 深层嵌套 → 移除 + if-return 扁平化 → `lint & type-check & test` ✓
- 第4轮：✓所有维度 → `✓ 代码复盘完成，满足所有质量要求`
