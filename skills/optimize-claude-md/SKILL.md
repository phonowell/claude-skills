---
name: optimize-claude-md
description: 优化 CLAUDE.md 遵循 100 行限制和渐进披露原则，use when updating/modifying/refactoring/optimizing CLAUDE.md
allowed-tools: Read, Grep, Glob, Edit, Bash
---

# CLAUDE.md 优化器

## 何时使用

- 优化/重构 `CLAUDE.md`，目标 ≤100 行并保留可执行约束
- 非 `CLAUDE.md` 文档优化：转 `optimize-docs`
- `SKILL.md` 优化：转 `optimize-skill`

## 核心意图

不丢关键约束/命令/流程的前提下，去冗余、提密度、可验证。

## 效率优先

Read/Edit/Bash > Task · 并行≤3 · 一次性 Edit

规范叠加：遵守 `optimize-docs` + 本 skill 的 CLAUDE.md 约束

## 核心约束

1. 行数：`wc -l` 必须 ≤100；先保关键约束，再压缩表达
2. 内容边界：仅保项目特定规则；删除通用知识/解释性文字
3. 可执行优先：命令/路径/流程不得损坏；冲突时信代码与当前仓库结构
4. 合理压缩：禁过度缩写；歧义处扩写到可执行
5. 必保留段：关键约束/技术栈/核心命令/目录结构/工作流/Skill 使用/代码规范/输出格式
6. 必保留原则：Skill 使用等待完成；精简冗余·冲突信代码；客观诚实；`try-catch` 仅高 ROI；≥3 步任务用 `/plans/task_plan_{suffix}.md`；输出格式约束
7. Token 控制：输出长度 ≤ 输入*5，优先符号压缩 `· → /`
8. 失败即中断：找不到文件、关键段冲突、验证未过时返回 ✗

## 输入/输出契约

- 输入：`CLAUDE.md` 路径、保留段、关键命令/路径、是否有 `AGENTS.md`
- 输出：优化后的 `CLAUDE.md` + `wc -l` 结果
- 成功：`✓ 已优化至 {行数} 行`
- 失败：`✗ 中断：{原因}`

## 工作流程

1. 确认范围：仅单 `CLAUDE.md`；多文件或架构决策转 `plan-implementation`
2. 读取并计数：Read + `wc -l` 并行获取内容与基线
3. 建保留清单：标注必保留段与项目特定命令/路径
4. 去冗余：删除通用知识/重复/解释性/低 ROI 内容
5. 压缩表达：合并同类项，符号化压缩，保留标题与可执行步骤
6. 冲突校验：规则互斥时优先当前仓库代码与有效命令
7. 一次性 Edit：统一完成修改，不分散多次小改
8. 验证：`wc -l CLAUDE.md` ≤100；必保留段齐全；命令/路径/链接有效
9. 返回：仅在验证通过后输出 `✓ 已优化至 {行数} 行`，否则 `✗ 中断：{原因}`

## 压缩优先级

P0 项目特定约束/自定义工具/关键路径
P1 工作流程/代码规范（项目特有）
P2 示例/背景/通用最佳实践

## 注意事项 / 错误处理

- 找不到 `CLAUDE.md` 或内容为空 → 中断并说明
- 关键段落缺失/冲突 → 先确认后再改
- 行数仍超限 → 再压缩，仍失败则拆分引用文档并补链接

## 检查清单

- [ ] 行数 ≤100，符号压缩，零通用/解释性/重复内容
- [ ] 必保留段齐全且不失真（关键约束/技术栈/核心命令/目录结构/工作流/Skill 使用/代码规范/输出格式）
- [ ] 必保留原则齐全（Skill 使用/元原则/客观诚实/异常处理/计划管理/输出约束）
- [ ] 返回信息格式正确
- [ ] 命令/路径/链接可执行或引用有效

## 快速参考

```
# CLAUDE.md
## 项目概览 ...
## 关键规则（结构/测试/安全/风格/行为）...
## 技术栈/代码规范 ...
## 目录结构/环境变量 ...
## 核心命令/工作流/任务 ...
## Skill 使用 ...
## 输出格式 ...
```
